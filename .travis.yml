dist: trusty
sudo: required
language: python
python:
- 2.7
cache:
  directories:
  - "~/.platformio"
env:
  global:
  - ROS_DISTRO=indigo
  - ROS_CI_DESKTOP="`lsb_release -cs`"
  - CI_SRC_PATH=$(pwd)
before_install:
- sudo sh -c "echo \"deb http://packages.ros.org/ros/ubuntu $ROS_CI_DESKTOP main\"
  > /etc/apt/sources.list.d/ros-latest.list"
- wget http://packages.ros.org/ros.key -O - | sudo apt-key add -
- sudo apt-get -qq update
install:
- sudo apt-get install -y ros-$ROS_DISTRO-catkin
- sudo apt-get install -y python-rosdep
- sudo apt-get install -y ros-$ROS_DISTRO-rosbash
- sudo apt-get install -y ros-$ROS_DISTRO-roscpp
- sudo apt-get install -y ros-$ROS_DISTRO-roslib
- sudo apt-get install -y ros-$ROS_DISTRO-rospy
- sudo apt-get install -y ros-$ROS_DISTRO-common-msgs
- sudo apt-get install -y ros-$ROS_DISTRO-topic-tools
- sudo apt-get install -y ros-$ROS_DISTRO-tf
- sudo apt-get install -y ros-$ROS_DISTRO-ackermann-msgs
- pip install -U rospkg
- pip install -U catkin_pkg
- pip install -U empy
- source /opt/ros/$ROS_DISTRO/setup.bash
- sudo rosdep init
- rosdep update
- pip install platformio
before_script:
- mkdir -p ~/catkin_ws/src
- cd ~/catkin_ws/src
- catkin_init_workspace
- git clone https://github.com/ros-drivers/rosserial.git --branch $ROS_DISTRO-devel
- git clone https://github.com/kittcar/kitt_msgs.git
- cd ~/catkin_ws
- catkin_make
- source ~/catkin_ws/devel/setup.bash
- mkdir -p sketchbook/libraries
- export ROSSERIAL_LIB_PATH=$(cd sketchbook/libraries; pwd)
- rosrun rosserial_arduino make_libraries.py $ROSSERIAL_LIB_PATH
- cd src
- git clone https://github.com/kittcar/Catch2.git
- export CATCH2_SINGLE_INCLUDE_DIR=$(cd Catch2/single_include; pwd)
- ln -s $CI_SRC_PATH .
script:
- cd ~/catkin_ws/src/kitt_platform/balor
- platformio run
- cd lib/balor
- mkdir build
- cd build
- cmake ..
- make
- make test
after_failure:
- make check
before_deploy:
- sudo apt-get install -y doxygen
- cd $CI_SRC_PATH
- doxygen
deploy:
  provider: s3
  access_key_id: "AKIAJCAG4GDO3A32L3KA"
  secret_access_key:
    secure: "QqRSXdtjdoHe7DbfHI0To+O3RcMW0jiwGaNqTtKUoSVlbPXB/SK/rZLsTbjV07y+F/jSdUWoOgK6IOw/WCX/4D+J6fryIZ4aDAtUeGQUIT0XM1EkNwCZpuRd2rCrQBBd3RhaqPazC7pJ/cagE+Sf01slY5mgDQjO2og6b3v9tgyIZwfTWFoOhM0urkLPVRlGd+lmG3DY/rVKHMJ7A4+kFjPWr/EroCN31iqh3euUk4gzuBgMQE9JXyc4114347r4PsQ/GqJHjLv4WZCAAxlHT2nVOk9wdi6fyiMf4KXqKWIAM9JV7oiJs8tCJf8IPqb9nGAHyhW2lB9gFOuA42v8Nr0eC2jvp7o2LofoRCw0OuoyKqxQcD4uAgyzSYJfGkRytFrclFDIXZN8tODBBKd3QyN0aDUca7+N4hgc8xJGg/BJb0kjc8cLGOcpYuQ8cqZPhZK+xBiik5hD7S9/TGgouZvISjffhVigYHGSc/q5yeYdsLnNeSN+3LZb7POpgunx56vGeA3Z2LdG1JLZnx6FRP3SCR2dmUQImLEKUdoMzaeNJzfoUAcx03FinRAfLBWEaNYbcPn8IgGU95J5fNPBg47YbOsSlEzVrhq24rDVCxvbzcVh1JzD4Kav1iT2SLl7CQh6FKF/qvVbGbGwVgjosj8be0Oivcg+BnVHgcSZ3vU=" 
  bucket: api.kittcar.com
  local-dir: "$CI_SRC_PATH/docs"
  upload-dir: kitt_platform
  skip_cleanup: true
  region: us-west-1
  acl: public_read
  on:
    repo: kittcar/kitt_platform
